<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-right: 3px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col z-20 shadow-2xl">
        <div class="p-6 border-b border-gray-700 flex items-center gap-3">
            <div class="bg-blue-600/20 p-2 rounded-lg">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                    </path>
                </svg>
            </div>
            <h1 class="font-bold text-lg tracking-wide text-gray-100">Admin Console</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 mt-2">
            <button onclick="switchTab('stats')" id="nav-stats"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400 active">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                    </path>
                </svg>
                <span class="font-medium">Overview</span>
            </button>
            <button onclick="switchTab('doctors')" id="nav-doctors"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                    </path>
                </svg>
                <span class="font-medium">Doctors</span>
            </button>
            <button onclick="switchTab('appointments')" id="nav-appointments"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                <span class="font-medium">Appointments</span>
            </button>
            <button onclick="switchTab('patients')" id="nav-patients"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                <span class="font-medium">Patients</span>
            </button>
            <button onclick="switchTab('security')" id="nav-security"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                    </path>
                </svg>
                <span class="font-medium">Security</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-700 bg-gray-800">
            <button onclick="logout()"
                class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 px-4 py-2 transition hover:bg-red-500/10 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                <span class="font-medium">Sign Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8 relative bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800">

        <!-- Stats Section -->
        <div id="statsSection" class="space-y-8 animate-fade-in max-w-6xl mx-auto">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white mb-1">Dashboard Overview</h2>
                <p class="text-gray-400">Welcome back, Administrator.</p>
            </header>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div
                    class="bg-gray-800/50 border border-gray-700/50 backdrop-blur-md rounded-2xl p-6 hover:bg-gray-800/70 transition duration-300 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Doctors</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="totalDocs">0</h3>
                        </div>
                        <div class="bg-blue-500/20 p-3 rounded-xl">
                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-gray-800/50 border border-gray-700/50 backdrop-blur-md rounded-2xl p-6 hover:bg-gray-800/70 transition duration-300 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Patients</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="totalPatients">0</h3>
                        </div>
                        <div class="bg-teal-500/20 p-3 rounded-xl">
                            <svg class="w-6 h-6 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-gray-800/50 border border-gray-700/50 backdrop-blur-md rounded-2xl p-6 hover:bg-gray-800/70 transition duration-300 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Today's Appointments</p>
                            <h3 class="text-4xl font-bold text-white mt-2" id="todayAppts">0</h3>
                        </div>
                        <div class="bg-purple-500/20 p-3 rounded-xl">
                            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Queue Monitor -->
            <div
                class="bg-gray-800/40 border border-gray-700/50 backdrop-blur-md rounded-2xl overflow-hidden shadow-xl">
                <div class="px-6 py-5 border-b border-gray-700/50 flex items-center justify-between bg-gray-800/50">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        Live Queue Activity
                    </h3>
                    <span
                        class="text-xs text-gray-400 bg-gray-900 px-3 py-1 rounded-full border border-gray-700">Real-Time</span>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="queueGrid">
                    <!-- Queue Cards loaded via JS -->
                </div>
            </div>
        </div>

        <!-- Doctors Management Section -->
        <div id="doctorsSection" class="hidden space-y-8 animate-fade-in max-w-6xl mx-auto">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white mb-1">Doctor Management</h2>
                <p class="text-gray-400">Register new medical staff and manage existing accounts.</p>
            </header>

            <!-- Register Doctor Section -->
            <div class="bg-gray-800/60 border border-gray-700/50 backdrop-blur-md rounded-2xl p-8 shadow-xl">
                <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2 border-b border-gray-700 pb-4">
                    <div class="bg-green-500/20 p-2 rounded-lg">
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    Register New Doctor
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Full Name</label>
                        <input type="text" id="newDocName" placeholder="Dr. John Doe"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Email (Login ID)</label>
                        <input type="email" id="newDocEmail" placeholder="doctor@hospital.com"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Password</label>
                        <input type="password" id="newDocPass" placeholder="••••••••"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Phone Number</label>
                        <input type="text" id="newDocPhone" placeholder="+91 9876543210"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Department</label>
                        <select id="newDocDept"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white transition">
                            <!-- Filled by JS -->
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Experience (Years)</label>
                        <input type="number" id="newDocExp" placeholder="e.g. 5"
                            class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                    </div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="addDoctor()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/30 transform transition hover:-translate-y-1 active:translate-y-0 text-sm tracking-wide">
                        Create Account
                    </button>
                </div>
            </div>

            <!-- Doctors List -->
            <div
                class="bg-gray-800/40 border border-gray-700/50 backdrop-blur-md rounded-2xl overflow-hidden shadow-xl">
                <div class="px-6 py-5 border-b border-gray-700/50 bg-gray-800/50">
                    <h3 class="text-lg font-bold text-white">Registered Medical Staff</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold">
                            <tr>
                                <th class="px-6 py-4 border-b border-gray-700/50">ID</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Doctor Name</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Department</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Email Contact</th>
                                <th class="px-6 py-4 border-b border-gray-700/50 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="doctorsTable" class="divide-y divide-gray-700/50 text-gray-300 text-sm">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Patients Section -->
        <div id="patientsSection" class="hidden animate-fade-in max-w-6xl mx-auto">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white mb-1">Patient Database</h2>
                <p class="text-gray-400">View registered patients and manage their accounts.</p>
            </header>

            <div
                class="bg-gray-800/40 border border-gray-700/50 backdrop-blur-md rounded-2xl overflow-hidden shadow-xl">
                <div class="px-6 py-5 border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50">
                    <h3 class="text-lg font-bold text-white">All Patients</h3>
                    <div class="relative">
                        <input type="text" placeholder="Search patients..."
                            class="bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500 w-64 transition focus:w-72">
                        <svg class="w-4 h-4 text-gray-500 absolute right-3 top-2.5 pointer-events-none" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold">
                            <tr>
                                <th class="px-6 py-4 border-b border-gray-700/50">ID</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Full Name</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Email</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Bio (Age/Sex)</th>
                                <th class="px-6 py-4 border-b border-gray-700/50 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTable" class="divide-y divide-gray-700/50 text-gray-300 text-sm">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Appointments Section -->
        <div id="appointmentsSection" class="hidden animate-fade-in max-w-6xl mx-auto">
            <header class="mb-4">
                <h2 class="text-3xl font-bold text-white mb-1">Appointment Schedule</h2>
                <p class="text-gray-400">Monitor today's patient visits.</p>
            </header>

            <div
                class="bg-gray-800/40 border border-gray-700/50 backdrop-blur-md rounded-2xl overflow-hidden shadow-xl">
                <div class="px-6 py-5 border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50">
                    <h3 class="text-lg font-bold text-white">Today's Appointments</h3>
                    <span
                        class="text-xs bg-blue-500/10 text-blue-300 px-3 py-1 rounded-full border border-blue-500/30 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                        Live View
                    </span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs font-semibold">
                            <tr>
                                <th class="px-6 py-4 border-b border-gray-700/50">Token</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Time</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Patient</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Doctor</th>
                                <th class="px-6 py-4 border-b border-gray-700/50">Type</th>
                                <th class="px-6 py-4 border-b border-gray-700/50 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminApptTable" class="divide-y divide-gray-700/50 text-gray-300 text-sm">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div id="securitySection" class="hidden animate-fade-in max-w-2xl mx-auto">
            <header class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-1">Security Settings</h2>
                <p class="text-gray-400">Update your account password.</p>
            </header>

            <div class="bg-gray-800/60 border border-gray-700/50 backdrop-blur-md rounded-2xl p-8 shadow-xl space-y-6">
                <div class="space-y-1">
                    <label class="text-xs uppercase text-gray-500 font-semibold ml-1">Current Password</label>
                    <input type="password" id="currentAdminPass" placeholder="••••••••"
                        class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                </div>
                <div class="space-y-1">
                    <label class="text-xs uppercase text-gray-500 font-semibold ml-1">New Password</label>
                    <input type="password" id="newAdminPass" placeholder="••••••••"
                        class="w-full bg-gray-900/50 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-600 transition">
                </div>
                <div class="pt-4">
                    <button onclick="changeAdminPassword()"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-900/30 transition transform active:scale-95">
                        Update Password
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Generic Dashboard Popup Modal (Replaces alert/confirm) -->
    <div id="dashboardPopup"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[200] hidden flex items-center justify-center p-4 text-center">
        <div class="bg-gray-900 border border-white/20 rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0 duration-300"
            id="popupContent">
            <div class="p-8">
                <div id="popupIcon" class="mb-6 inline-block p-4 rounded-full bg-white/5">
                    <!-- Icon -->
                </div>
                <h3 id="popupTitle" class="text-xl font-bold text-white mb-2">Notice</h3>
                <p id="popupMessage" class="text-gray-400 leading-relaxed mb-8">Message goes here.</p>
                <div class="flex gap-4" id="popupActions">
                    <button id="popupConfirm"
                        class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-900/40">
                        Okay
                    </button>
                    <button id="popupCancel"
                        class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-xl transition hidden">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-8 right-8 z-[250] space-y-4"></div>

    <script src="../js/api.js?v=1.3"></script>
    <script>
        checkAuth('admin');

        function logout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        async function init() {
            const res = await api.get('/auth/me');
            window.adminUser = res.user;
            loadStats();
            setInterval(loadStats, 5000);
            loadDeptsForForm();
        }

        function switchTab(tab) {
            // Update Nav Styling
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Hide all Sections
            ['statsSection', 'doctorsSection', 'patientsSection', 'appointmentsSection', 'securitySection'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Show selected Section
            document.getElementById(tab + 'Section').classList.remove('hidden');

            // Load Data
            if (tab === 'doctors') loadDoctorsList();
            if (tab === 'patients') loadPatientsList();
            if (tab === 'appointments') loadTodaysAppointments();
        }

        async function loadStats() {
            if (document.getElementById('statsSection').classList.contains('hidden')) return;

            const res = await api.get('/admin/stats');

            document.getElementById('totalDocs').innerText = res.total_doctors;
            document.getElementById('totalPatients').innerText = res.total_patients;
            document.getElementById('todayAppts').innerText = res.today_appointments;

            const qGrid = document.getElementById('queueGrid');
            if (res.queues && res.queues.length > 0) {
                qGrid.innerHTML = res.queues.map(q => `
                    <div class="bg-gray-900/60 border border-gray-600/50 rounded-xl p-4 text-center transform transition hover:scale-105 shadow-lg">
                        <h4 class="font-bold text-lg text-gray-200">Dr. ${q.full_name}</h4>
                        <div class="mt-3 text-5xl font-extrabold text-blue-400 tracking-tighter">${q.current_token}</div>
                        <p class="text-xs text-gray-500 uppercase mt-2 font-semibold tracking-wide">Serving Token</p>
                    </div>
                `).join('');
            } else {
                qGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-4">No active queues at the moment.</p>';
            }
        }

        async function loadDoctorsList() {
            const docs = await api.get('/admin/doctors');
            const tbody = document.getElementById('doctorsTable');
            tbody.innerHTML = docs.map(d => `
                <tr class="hover:bg-gray-700/30 transition">
                    <td class="px-6 py-4 text-gray-500 font-mono">#${d.id}</td>
                    <td class="px-6 py-4 font-bold text-white">Dr. ${d.full_name}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-lg text-xs font-bold bg-blue-900/30 text-blue-300 border border-blue-500/30">
                            ${d.dept_name}
                        </span>
                        <div class="text-xs text-gray-500 mt-1">${d.specialization}</div>
                    </td>
                    <td class="px-6 py-4 text-gray-400">${d.email}</td>
                    <td class="px-6 py-4 text-gray-400 font-mono text-right flex items-center justify-end gap-3">
                        <span class="text-xs">${d.phone || '-'}</span>
                        <button onclick="deleteUser(${d.user_id}, 'doctor')" class="text-red-400 hover:text-white bg-red-500/10 hover:bg-red-500 transition p-2 rounded-lg" title="Delete Doctor">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadPatientsList() {
            const pats = await api.get('/admin/patients');
            const tbody = document.getElementById('patientsTable');
            tbody.innerHTML = pats.map(p => `
                <tr class="hover:bg-gray-700/30 transition">
                    <td class="px-6 py-4 text-gray-500 font-mono">#${p.id}</td>
                    <td class="px-6 py-4 font-bold text-white">${p.full_name}</td>
                    <td class="px-6 py-4 text-gray-400">${p.email}</td>
                    <td class="px-6 py-4 text-gray-400">${p.age} Y / <span class="uppercase">${p.gender}</span></td>
                    <td class="px-6 py-4 font-mono text-gray-400 text-right flex items-center justify-end gap-3">
                        <span class="text-xs">${p.phone}</span>
                        <button onclick="deleteUser(${p.user_id}, 'patient')" class="text-red-400 hover:text-white bg-red-500/10 hover:bg-red-500 transition p-2 rounded-lg" title="Delete Patient">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadTodaysAppointments() {
            const appts = await api.get('/admin/todays-appointments');
            const tbody = document.getElementById('adminApptTable');
            if (appts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No appointments scheduled for today.</td></tr>';
                return;
            }
            tbody.innerHTML = appts.map(a => `
                <tr class="hover:bg-gray-700/30 transition">
                    <td class="px-6 py-4 text-blue-400 font-bold font-mono text-lg">#${a.token_number}</td>
                    <td class="px-6 py-4 font-mono text-gray-300 font-medium">${a.appointment_time}</td>
                    <td class="px-6 py-4 font-bold text-white">${a.patient_name}</td>
                    <td class="px-6 py-4">
                        <div class="text-white text-sm font-medium">Dr. ${a.doctor_name}</div>
                        <div class="text-xs text-gray-500">${a.specialization}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-xs font-bold uppercase tracking-wider px-2 py-1 rounded bg-gray-800 border border-gray-700 ${a.type === 'emergency' ? 'text-red-400 border-red-500/50' : 'text-gray-400'}">
                            ${a.type}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${a.status === 'completed' ? 'bg-green-500/20 text-green-400 ring-1 ring-green-500/50' : (a.status === 'cancelled' ? 'bg-red-500/20 text-red-400 ring-1 ring-red-500/50' : 'bg-yellow-500/20 text-yellow-400 ring-1 ring-yellow-500/50')}">
                            ${a.status}
                        </span>
                    </td>
                </tr >
                `).join('');
        }

        async function loadDeptsForForm() {
            const depts = await api.get('/patient/departments');
            const sel = document.getElementById('newDocDept');
            sel.innerHTML = '<option value="" class="bg-gray-800 text-gray-500">Select Department</option>' +
                depts.map(d => `<option value="${d.id}" class="bg-gray-800 text-white">${d.name}</option>`).join('');
        }

        async function addDoctor() {
            const data = {
                full_name: document.getElementById('newDocName').value,
                email: document.getElementById('newDocEmail').value,
                password: document.getElementById('newDocPass').value,
                phone: document.getElementById('newDocPhone').value,
                department_id: document.getElementById('newDocDept').value,
                experience: document.getElementById('newDocExp').value
            };

            if (!data.full_name || !data.email || !data.password || !data.department_id) {
                return showToast('Please fill all required fields', 'warning');
            }

            try {
                const res = await api.post('/admin/add-doctor', data);
                if (res.message === 'Doctor added successfully') {
                    showToast('Doctor added successfully!', 'success');
                    loadDoctorsList();
                    // Clear inputs
                    ['newDocName', 'newDocEmail', 'newDocPass', 'newDocPhone', 'newDocExp'].forEach(id => document.getElementById(id).value = '');
                    document.getElementById('newDocDept').value = '';
                } else {
                    showToast('Error: ' + res.message, 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteUser(userId, role) {
            const confirmed = await showPopup('Confirm Deletion', `Are you sure you want to delete this ${role}? This action cannot be undone.`, 'error', true);
            if (!confirmed) return;

            try {
                const res = await api.del(`/admin/users/${userId}`);
                if (res.message === 'User deleted successfully') {
                    showToast('User deleted successfully', 'success');
                    if (role === 'doctor') loadDoctorsList();
                    if (role === 'patient') loadPatientsList();
                    loadStats(); // Update stats as well
                } else {
                    showToast(res.message || 'Failed to delete user', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function changeAdminPassword() {
            const currentPass = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            if (!currentPass || !newPass) return showToast('Please fill both fields', 'warning');

            try {
                const res = await api.post('/auth/change-password', {
                    user_id: window.adminUser.id,
                    current_password: currentPass,
                    new_password: newPass
                });
                if (res.message === 'Password updated successfully') {
                    showToast('Password updated successfully!', 'success');
                    document.getElementById('currentAdminPass').value = '';
                    document.getElementById('newAdminPass').value = '';
                } else {
                    showToast(res.message || 'Failed to update password', 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        // Dashboard UI Helpers (Replaces Alerts)
        function showPopup(title, message, type = 'info', isConfirm = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('dashboardPopup');
                const content = document.getElementById('popupContent');
                const titleEl = document.getElementById('popupTitle');
                const msgEl = document.getElementById('popupMessage');
                const iconEl = document.getElementById('popupIcon');
                const btnConfirm = document.getElementById('popupConfirm');
                const btnCancel = document.getElementById('popupCancel');

                titleEl.innerText = title;
                msgEl.innerText = message;

                // Set Icon and Colors based on type
                let iconHtml = '';
                if (type === 'success') {
                    iconHtml = '<svg class="w-12 h-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                } else if (type === 'error') {
                    iconHtml = '<svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                } else {
                    iconHtml = '<svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }
                iconEl.innerHTML = iconHtml;

                btnCancel.classList.toggle('hidden', !isConfirm);
                btnConfirm.innerText = isConfirm ? 'Confirm' : 'Got it';

                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);

                const cleanup = (val) => {
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        resolve(val);
                    }, 300);
                };

                btnConfirm.onclick = () => cleanup(true);
                btnCancel.onclick = () => cleanup(false);
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `transform translate-y-4 opacity-0 transition-all duration-300 bg-gray-900/90 backdrop-blur-md border border-white/10 px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[300px] border-l-4 ${type === 'success' ? 'border-l-blue-500' : type === 'error' ? 'border-l-red-500' : 'border-l-yellow-500'}`;

            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            toast.innerHTML = `<span class="text-xl">${icon}</span><span class="text-white font-medium">${message}</span>`;

            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        init();
    </script>
</body>

</html>