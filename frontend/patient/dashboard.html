<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Glassmorphism scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body
    class="bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-900 via-purple-900 to-pink-900 text-white min-h-screen relative overflow-x-hidden">
    <!-- Background removed, using CSS gradient on body -->


    <!-- Content -->
    <div class="relative z-10 flex flex-col min-h-screen">

        <!-- Navbar -->
        <nav class="bg-white/10 backdrop-blur-lg border-b border-white/20 sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/80 p-2 rounded-xl shadow-lg shadow-blue-500/30">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                            </path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white tracking-wide">MediCare Patient</h1>
                </div>

                <div class="flex items-center gap-6">
                    <div onclick="openProfileModal()"
                        class="hidden md:flex items-center gap-3 bg-white/10 px-4 py-2 rounded-full border border-white/10 cursor-pointer hover:bg-white/20 transition">
                        <div
                            class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-xs font-bold shadow-md">
                            PT
                        </div>
                        <span id="navName" class="text-sm font-medium text-blue-50">Loading...</span>
                    </div>
                    <button onclick="logout()"
                        class="text-white/80 hover:text-white transition-colors font-medium text-sm flex items-center gap-2">
                        Sign Out
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex-grow max-w-7xl mx-auto px-4 py-10 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Profile & Booking -->
            <div class="col-span-1 space-y-8">

                <!-- Emergency Card -->
                <div
                    class="bg-gradient-to-br from-red-600/20 to-red-900/40 backdrop-blur-md rounded-3xl p-6 border border-red-500/30 shadow-2xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-500/20 rounded-full blur-2xl animate-pulse">
                    </div>

                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                        <span class="bg-red-500 p-1.5 rounded-lg animate-pulse">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                        </span>
                        Emergency SOS
                    </h2>
                    <p class="text-xs text-red-200 mb-4 bg-red-900/30 p-2 rounded border border-red-500/20">
                        Immediate priority booking. We will assign the first available doctor.
                    </p>

                    <div class="space-y-4">
                        <div class="relative">
                            <select id="emDeptSelect"
                                class="w-full bg-black/40 border border-red-400/30 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none backdrop-blur-sm transition hover:bg-black/50">
                                <option class="bg-gray-800" value="">Select Department</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-0 flex items-center px-4 text-red-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <button onclick="bookEmergency()"
                            class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-500/40 transform transition hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                            Get Help Now
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Pharmacy Card -->
                <div onclick="window.location.href='medical.html'"
                    class="cursor-pointer group relative bg-gradient-to-br from-emerald-600/20 to-teal-900/40 backdrop-blur-md rounded-3xl p-6 border border-emerald-500/30 shadow-2xl overflow-hidden hover:bg-emerald-600/30 transition duration-300">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-400/30 transition">
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="bg-emerald-500 p-1.5 rounded-lg shadow-lg shadow-emerald-500/40">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                            </span>
                            Pharmacy Store
                        </h2>
                        <svg class="w-5 h-5 text-emerald-300 group-hover:translate-x-1 transition" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-emerald-100/80 mb-0">Buy medicines online securely.</p>
                </div>

                <!-- Report Analyzer Card -->
                <div onclick="window.location.href='analyze-report.html'"
                    class="cursor-pointer group relative bg-gradient-to-br from-indigo-600/20 to-purple-900/40 backdrop-blur-md rounded-3xl p-6 border border-indigo-500/30 shadow-2xl overflow-hidden hover:bg-indigo-600/30 transition duration-300">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl group-hover:bg-indigo-400/30 transition">
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="bg-indigo-500 p-1.5 rounded-lg shadow-lg shadow-indigo-500/40">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </span>
                            Report Analyzer AI
                        </h2>
                        <svg class="w-5 h-5 text-indigo-300 group-hover:translate-x-1 transition" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-indigo-100/80 mb-0">Get AI-powered analysis of your medical reports.</p>
                </div>

            </div>

            <!-- Right Column: History & Status -->
            <div class="col-span-1 lg:col-span-2 space-y-6">

                <!-- Booking Card (Moved Here) -->
                <div id="pauseBanner"
                    class="hidden bg-orange-600/20 border border-orange-500/50 rounded-2xl p-4 mb-6 animate-pulse flex items-center gap-4">
                    <div class="bg-orange-500 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-orange-200">Consultations Paused</h4>
                        <p id="pauseReasonDisplay" class="text-sm text-orange-300/80">The doctor is currently attending
                            to an emergency.</p>
                    </div>
                </div>

                <div
                    class="bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-md rounded-3xl p-6 border border-white/20 shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Book Appointment
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        <div>
                            <label
                                class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Department</label>
                            <select id="deptSelect" onchange="loadDoctors()"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none backdrop-blur-sm transition hover:bg-black/30">
                                <option class="bg-gray-800" value="">Select Department</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-6 flex items-center px-4 text-white/50">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Doctor</label>
                            <select id="docSelect"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none backdrop-blur-sm hover:bg-black/30 transition">
                                <option class="bg-gray-800" value="">Select Doctor</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-6 flex items-center px-4 text-white/50">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Date</label>
                            <input type="date" id="dateInput" onchange="checkDate()"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 backdrop-blur-sm [color-scheme:dark]">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Time</label>
                            <input type="time" id="timeInput"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 backdrop-blur-sm [color-scheme:dark]">
                        </div>
                    </div>

                    <button onclick="bookAppt()"
                        class="mt-6 w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transform transition hover:-translate-y-1 active:scale-95">
                        Confirm Booking
                    </button>
                </div>

                <!-- History Table -->
                <div
                    class="bg-white/10 backdrop-blur-md rounded-3xl overflow-hidden border border-white/20 shadow-xl min-h-[500px]">
                    <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-black/20">
                        <h2 class="text-xl font-bold text-white">Appointment History</h2>
                        <button onclick="loadHistory()"
                            class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left">
                            <thead class="bg-black/20 text-blue-200 uppercase text-xs font-semibold tracking-wider">
                                <tr>
                                    <th class="px-8 py-5">Date & Time</th>
                                    <th class="px-6 py-5">Doctor</th>
                                    <th class="px-6 py-5 text-center">Token</th>
                                    <th class="px-6 py-5 text-center">Status</th>
                                    <th class="px-6 py-5 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="divide-y divide-white/10 text-gray-100 text-sm">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-3xl w-full max-w-md border border-white/10 shadow-2xl overflow-hidden">
            <div
                class="p-6 bg-gradient-to-r from-blue-900/50 to-purple-900/50 flex justify-between items-center border-b border-white/10">
                <h2 class="text-xl font-bold text-white">My Profile</h2>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>

            <div class="p-8 space-y-6">
                <!-- Profile Details -->
                <div id="modalProfileInfo" class="space-y-4">
                    <div class="animate-pulse h-4 bg-white/20 rounded w-1/2"></div>
                </div>

                <hr class="border-white/10">

                <!-- Change Password -->
                <div>
                    <h3 class="text-lg font-bold text-blue-300 mb-4">Change Password</h3>
                    <div class="space-y-3">
                        <input type="password" id="currentPassword" placeholder="Current Password"
                            class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="newPassword" placeholder="New Password"
                            class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="changePassword()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Update
                            Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Dashboard Popup Modal (Replaces alert/confirm) -->
    <div id="dashboardPopup"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-white/20 rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all scale-95 opacity-0 duration-300"
            id="popupContent">
            <div class="p-8 text-center">
                <div id="popupIcon" class="mb-6 inline-block p-4 rounded-full bg-white/5">
                    <!-- Icon -->
                </div>
                <h3 id="popupTitle" class="text-xl font-bold text-white mb-2">Notice</h3>
                <p id="popupMessage" class="text-gray-400 leading-relaxed mb-8">Message goes here.</p>
                <div class="flex gap-4" id="popupActions">
                    <button id="popupConfirm"
                        class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-900/40">
                        Okay
                    </button>
                    <button id="popupCancel"
                        class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-xl transition hidden">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-8 right-8 z-[250] space-y-4"></div>

    <script src="../js/api.js?v=1.6"></script>
    <script>
        checkAuth('patient');
        let profile = null;
        let userId = null;

        async function init() {
            // Get Profile
            const res = await api.get('/auth/me');
            if (res.profile) {
                profile = res.profile;
                userId = res.user.id;
                document.getElementById('navName').innerText = profile.full_name;

                // Populate Modal Profile Info
                const pInfo = document.getElementById('modalProfileInfo');
                if (pInfo) {
                    pInfo.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Name</p>
                                <p class="font-bold text-lg text-white">${profile.full_name}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Contact</p>
                                <p class="font-bold text-lg text-white">${profile.phone}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Age</p>
                                <p class="font-bold text-lg text-white">${profile.age}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Gender</p>
                                <p class="font-bold text-lg text-white">${profile.gender}</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Load Departments
            const depts = await api.get('/patient/departments');
            const dSel = document.getElementById('deptSelect');
            const emSel = document.getElementById('emDeptSelect');

            const deptOptions = '<option class="bg-gray-800" value="">Select Department</option>' +
                depts.map(d => `<option class="bg-gray-800" value="${d.id}">${d.name}</option>`).join('');

            dSel.innerHTML = deptOptions;
            if (emSel) emSel.innerHTML = deptOptions;

            loadHistory();
            checkNotifications(); // Run immediately
        }

        function getDoctorTitle(deptName) {
            const map = {
                'Cardiology': 'Cardiologist',
                'Neurology': 'Neurologist',
                'Orthopedics': 'Orthopedist',
                'Pediatrics': 'Pediatrician',
                'General Medicine': 'MBBS, General Physician',
                'Dermatology': 'Dermatologist',
                'Gynecology': 'Gynecologist',
                'Gynaecology': 'Gynecologist',
                'Dental': 'Dentist',
                'Psychiatry': 'Psychiatrist',
                'ENT': 'ENT Specialist',
                'Ophthalmology': 'Ophthalmologist'
            };
            return map[deptName] || 'MBBS, General';
        }

        async function loadDoctors() {
            const deptId = document.getElementById('deptSelect').value;
            if (!deptId) return;
            const docs = await api.get(`/patient/doctors?department_id=${deptId}`);
            const docSel = document.getElementById('docSelect');
            docSel.innerHTML = '<option class="bg-gray-800" value="">Select Doctor</option>' +
                docs.map(d => {
                    const title = getDoctorTitle(d.dept_name);
                    return `<option class="bg-gray-800" value="${d.id}">Dr. ${d.full_name} (${title})</option>`;
                }).join('');
        }

        async function checkDate() {
            const docId = document.getElementById('docSelect').value;
            const date = document.getElementById('dateInput').value;
            if (!docId || !date) return;

            try {
                const res = await api.get(`/patient/check-availability?doctor_id=${docId}&date=${date}`);
                if (!res.available) {
                    showPopup('Doctor Availability', res.message, 'warning');
                    document.getElementById('dateInput').value = ''; // Clear invalid date
                }
            } catch (e) { console.error(e); }
        }

        async function bookAppt() {
            const docId = document.getElementById('docSelect').value;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            // Removed isEm check from regular form

            if (!docId || !date || !time) return showToast('Please fill all fields', 'warning');

            try {
                const res = await api.post('/patient/book', {
                    patient_id: profile.id,
                    doctor_id: docId,
                    date: date,
                    time: time + ":00",
                    is_emergency: false // Always false for regular form
                });

                if (res.token) {
                    showPopup('Booking Successful', `Your appointment is confirmed.\n\nYour Token Number: ${res.token}`, 'success');
                    loadHistory();
                    document.getElementById('dateInput').value = '';
                    document.getElementById('timeInput').value = '';
                } else {
                    showToast(res.message, 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function bookEmergency() {
            const deptId = document.getElementById('emDeptSelect').value;
            if (!deptId) return showToast('Please select a department first!', 'warning');

            const confirmed = await showPopup('Confirm Emergency', 'This is an EMERGENCY booking.\n- It will be booked for NOW.\n- It will be marked as high priority.\n\nProceed?', 'emergency', true);
            if (!confirmed) return;

            // We need to pick a doctor from that department.
            try {
                const docs = await api.get(`/patient/doctors?department_id=${deptId}`);
                if (!docs || docs.length === 0) return showPopup('No Doctors', 'No doctors found in this department!', 'error');

                // Pick the first one automatically for emergency speed
                const docId = docs[0].id;

                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0];

                const res = await api.post('/patient/book', {
                    patient_id: profile.id,
                    doctor_id: docId,
                    date: dateStr,
                    time: timeStr,
                    is_emergency: true
                });

                if (res.token) {
                    showPopup('üö® EMERGENCY BOOKED üö®', `Priority Token: ${res.token}\nDoctor: Dr. ${docs[0].full_name}\n\nGo immediately to the department.`, 'emergency');
                    loadHistory();
                } else {
                    showToast(res.message, 'error');
                }

            } catch (e) {
                showToast('Error booking emergency: ' + e.message, 'error');
            }
        }

        async function loadHistory() {
            if (!profile) return;
            const res = await api.get(`/patient/appointments/${profile.id}`);
            const tbody = document.getElementById('historyTable');

            if (res.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-8 py-8 text-center text-gray-400">No appointments found.</td></tr>';
                return;
            }

            tbody.innerHTML = res.map(a => `
                <tr class="hover:bg-white/5 transition group">
                    <td class="px-8 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-white">${new Date(a.appointment_date).toDateString()}</div>
                        <div class="text-xs text-purple-200">${a.appointment_time.substring(0, 5)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-white">Dr. ${a.doctor_name}</div>
                        <div class="text-xs text-blue-200">${a.dept_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-500/20 text-blue-200 font-bold border border-blue-500/30">
                            ${a.token_number}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                         <div class="flex flex-col items-center gap-1">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(a.status)} border border-white/10 shadow-sm">
                                ${a.status}
                            </span>
                            ${a.status === 'rescheduled' && a.reschedule_note ?
                    `<p class="text-[10px] text-blue-300 italic max-w-[150px] truncate" title="${a.reschedule_note}">Note: ${a.reschedule_note}</p>` : ''}
                         </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end gap-3 opacity-80 group-hover:opacity-100 transition">
                            <button onclick="checkQueue(${a.doctor_id}, '${a.appointment_date}')" class="text-yellow-300 hover:text-yellow-200" title="Check Live Queue">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                            ${a.status !== 'cancelled' ? `
                            <a href="${BASE_URL}/patient/prescription/download/${a.id}" target="_blank" class="text-green-300 hover:text-green-200" title="Download PDF">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </a>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(s) {
            if (s === 'pending') return 'bg-yellow-500/20 text-yellow-300';
            if (s === 'accepted') return 'bg-green-500/20 text-green-300';
            if (s === 'rescheduled') return 'bg-blue-500/20 text-blue-300';
            if (s === 'called') return 'bg-teal-500/20 text-teal-300 animate-pulse';
            if (s === 'completed') return 'bg-green-500/20 text-green-300';
            if (s === 'cancelled') return 'bg-red-500/20 text-red-300';
            return 'bg-gray-500/20 text-gray-300';
        }

        async function checkQueue(docId, date) {
            try {
                const d = date.split('T')[0];
                const res = await api.get(`/patient/queue-status?doctor_id=${docId}&date=${d}`);

                // Also check if doctor is paused
                const docDetails = await api.get(`/doctor/me?doctor_id=${docId}`);
                const banner = document.getElementById('pauseBanner');
                const reasonEl = document.getElementById('pauseReasonDisplay');

                if (docDetails.is_paused) {
                    banner.classList.remove('hidden');
                    reasonEl.innerText = docDetails.pause_reason || "Attending to an emergency.";
                    showPopup('Consultations Paused', `Dr. ${docDetails.full_name} has temporarily paused consultations.\nReason: ${docDetails.pause_reason}\n\nPlease wait in the lounge.`, 'warning');
                } else {
                    banner.classList.add('hidden');
                    showPopup('Live Queue Status', `Current Serving Token: ${res.current_token}`, 'info');
                }
            } catch (e) {
                showToast('Could not fetch queue status', 'error');
            }
        }

        // Profile Modal Logic
        function openProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        async function changePassword() {
            const currentPw = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            if (!currentPw || !newPw) return showToast('Please enter both current and new passwords', 'warning');

            try {
                const res = await api.post('/auth/change-password', {
                    user_id: userId,
                    current_password: currentPw,
                    new_password: newPw
                });
                if (res.message === 'Password updated successfully') {
                    showToast('Password updated successfully!', 'success');
                    closeProfileModal();
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                } else {
                    showToast(res.message || 'Failed to update password', 'error');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        init();

        // Dashboard UI Helpers (Replaces Alerts)
        function showPopup(title, message, type = 'info', isConfirm = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('dashboardPopup');
                const content = document.getElementById('popupContent');
                const titleEl = document.getElementById('popupTitle');
                const msgEl = document.getElementById('popupMessage');
                const iconEl = document.getElementById('popupIcon');
                const btnConfirm = document.getElementById('popupConfirm');
                const btnCancel = document.getElementById('popupCancel');

                titleEl.innerText = title;
                msgEl.innerText = message;

                // Set Icon and Colors based on type
                let iconHtml = '';
                if (type === 'success') {
                    iconHtml = '<svg class="w-12 h-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                } else if (type === 'error') {
                    iconHtml = '<svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                } else if (type === 'emergency') {
                    iconHtml = '<svg class="w-12 h-12 text-orange-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
                } else {
                    iconHtml = '<svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }
                iconEl.innerHTML = iconHtml;

                btnCancel.classList.toggle('hidden', !isConfirm);
                btnConfirm.innerText = isConfirm ? 'Confirm' : 'Got it';

                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);

                const cleanup = (val) => {
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        resolve(val);
                    }, 300);
                };

                btnConfirm.onclick = () => cleanup(true);
                btnCancel.onclick = () => cleanup(false);
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `transform translate-y-4 opacity-0 transition-all duration-300 bg-gray-900/90 backdrop-blur-md border border-white/10 px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[300px] border-l-4 ${type === 'success' ? 'border-l-green-500' : type === 'error' ? 'border-l-red-500' : 'border-l-blue-500'}`;

            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            toast.innerHTML = `<span class="text-xl">${icon}</span><span class="text-white font-medium">${message}</span>`;

            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Notification System (Background Polling)
        let activeNotificationId = null;

        async function checkNotifications() {
            if (!profile || !profile.id) return;
            try {
                // Check general notifications
                const notifications = await api.get(`/patient/notifications?patient_id=${profile.id}`);
                if (notifications && notifications.length > 0) {
                    const notif = notifications[0];
                    if (notif.id !== activeNotificationId) {
                        activeNotificationId = notif.id;
                        const type = notif.type === 'CALL_NEXT' ? 'success' : 'info';
                        const title = notif.type === 'CALL_NEXT' ? 'Doctor is Ready' : 'Appointment Reminder';

                        await showPopup(title, notif.message, type);
                        loadHistory();
                        try { await api.post('/patient/notifications/mark-read', { notification_id: notif.id }); } catch (e) { }
                        activeNotificationId = null;
                    }
                }

                // Check for paused doctors today
                const history = await api.get(`/patient/appointments/${profile.id}`);
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                let pausedDoctor = null;
                for (const a of history) {
                    const apptDate = a.appointment_date.split('T')[0];
                    if (apptDate === todayStr && (a.status === 'pending' || a.status === 'called' || a.status === 'accepted')) {
                        const docDetails = await api.get(`/doctor/me?doctor_id=${a.doctor_id}`);
                        if (docDetails.is_paused) {
                            pausedDoctor = docDetails;
                            break;
                        }
                    }
                }

                const banner = document.getElementById('pauseBanner');
                const reasonEl = document.getElementById('pauseReasonDisplay');
                if (pausedDoctor) {
                    banner.classList.remove('hidden');
                    reasonEl.innerText = `Dr. ${pausedDoctor.full_name} is on a break: ${pausedDoctor.pause_reason || "Emergency"}`;
                } else {
                    banner.classList.add('hidden');
                }
            } catch (e) {
                console.error("Failed background check", e);
            }
        }

        // Start polling
        setInterval(checkNotifications, 5000);
    </script>
</body>

</html>