<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Glassmorphism scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body
    class="bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-900 via-purple-900 to-pink-900 text-white min-h-screen relative overflow-x-hidden">
    <!-- Background removed, using CSS gradient on body -->


    <!-- Content -->
    <div class="relative z-10 flex flex-col min-h-screen">

        <!-- Navbar -->
        <nav class="bg-white/10 backdrop-blur-lg border-b border-white/20 sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/80 p-2 rounded-xl shadow-lg shadow-blue-500/30">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                            </path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white tracking-wide">MediCare Patient</h1>
                </div>

                <div class="flex items-center gap-6">
                    <div onclick="openProfileModal()"
                        class="hidden md:flex items-center gap-3 bg-white/10 px-4 py-2 rounded-full border border-white/10 cursor-pointer hover:bg-white/20 transition">
                        <div
                            class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-xs font-bold shadow-md">
                            PT
                        </div>
                        <span id="navName" class="text-sm font-medium text-blue-50">Loading...</span>
                    </div>
                    <button onclick="logout()"
                        class="text-white/80 hover:text-white transition-colors font-medium text-sm flex items-center gap-2">
                        Sign Out
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex-grow max-w-7xl mx-auto px-4 py-10 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Profile & Booking -->
            <div class="col-span-1 space-y-8">

                <!-- Emergency Card -->
                <div
                    class="bg-gradient-to-br from-red-600/20 to-red-900/40 backdrop-blur-md rounded-3xl p-6 border border-red-500/30 shadow-2xl relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-500/20 rounded-full blur-2xl animate-pulse">
                    </div>

                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                        <span class="bg-red-500 p-1.5 rounded-lg animate-pulse">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                        </span>
                        Emergency SOS
                    </h2>
                    <p class="text-xs text-red-200 mb-4 bg-red-900/30 p-2 rounded border border-red-500/20">
                        Immediate priority booking. We will assign the first available doctor.
                    </p>

                    <div class="space-y-4">
                        <div class="relative">
                            <select id="emDeptSelect"
                                class="w-full bg-black/40 border border-red-400/30 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none backdrop-blur-sm transition hover:bg-black/50">
                                <option class="bg-gray-800" value="">Select Department</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-0 flex items-center px-4 text-red-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <button onclick="bookEmergency()"
                            class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-500/40 transform transition hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2">
                            Get Help Now
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Pharmacy Card -->
                <div onclick="window.location.href='medical.html'"
                    class="cursor-pointer group relative bg-gradient-to-br from-emerald-600/20 to-teal-900/40 backdrop-blur-md rounded-3xl p-6 border border-emerald-500/30 shadow-2xl overflow-hidden hover:bg-emerald-600/30 transition duration-300">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-400/30 transition">
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span class="bg-emerald-500 p-1.5 rounded-lg shadow-lg shadow-emerald-500/40">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                </svg>
                            </span>
                            Pharmacy Store
                        </h2>
                        <svg class="w-5 h-5 text-emerald-300 group-hover:translate-x-1 transition" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-emerald-100/80 mb-0">Buy medicines online securely.</p>
                </div>


            </div>

            <!-- Right Column: History & Status -->
            <div class="col-span-1 lg:col-span-2 space-y-6">

                <!-- Booking Card (Moved Here) -->
                <div
                    class="bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-md rounded-3xl p-6 border border-white/20 shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Book Appointment
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        <div>
                            <label
                                class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Department</label>
                            <select id="deptSelect" onchange="loadDoctors()"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none backdrop-blur-sm transition hover:bg-black/30">
                                <option class="bg-gray-800" value="">Select Department</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-6 flex items-center px-4 text-white/50">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Doctor</label>
                            <select id="docSelect"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none backdrop-blur-sm hover:bg-black/30 transition">
                                <option class="bg-gray-800" value="">Select Doctor</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 top-6 flex items-center px-4 text-white/50">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Date</label>
                            <input type="date" id="dateInput" onchange="checkDate()"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 backdrop-blur-sm [color-scheme:dark]">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-blue-200 uppercase mb-1 ml-1">Time</label>
                            <input type="time" id="timeInput"
                                class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 backdrop-blur-sm [color-scheme:dark]">
                        </div>
                    </div>

                    <button onclick="bookAppt()"
                        class="mt-6 w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transform transition hover:-translate-y-1 active:scale-95">
                        Confirm Booking
                    </button>
                </div>

                <!-- History Table -->
                <div
                    class="bg-white/10 backdrop-blur-md rounded-3xl overflow-hidden border border-white/20 shadow-xl min-h-[500px]">
                    <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-black/20">
                        <h2 class="text-xl font-bold text-white">Appointment History</h2>
                        <button onclick="loadHistory()"
                            class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left">
                            <thead class="bg-black/20 text-blue-200 uppercase text-xs font-semibold tracking-wider">
                                <tr>
                                    <th class="px-8 py-5">Date & Time</th>
                                    <th class="px-6 py-5">Doctor</th>
                                    <th class="px-6 py-5 text-center">Token</th>
                                    <th class="px-6 py-5 text-center">Status</th>
                                    <th class="px-6 py-5 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="divide-y divide-white/10 text-gray-100 text-sm">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-3xl w-full max-w-md border border-white/10 shadow-2xl overflow-hidden">
            <div
                class="p-6 bg-gradient-to-r from-blue-900/50 to-purple-900/50 flex justify-between items-center border-b border-white/10">
                <h2 class="text-xl font-bold text-white">My Profile</h2>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>

            <div class="p-8 space-y-6">
                <!-- Profile Details -->
                <div id="modalProfileInfo" class="space-y-4">
                    <div class="animate-pulse h-4 bg-white/20 rounded w-1/2"></div>
                </div>

                <hr class="border-white/10">

                <!-- Change Password -->
                <div>
                    <h3 class="text-lg font-bold text-blue-300 mb-4">Change Password</h3>
                    <div class="space-y-3">
                        <input type="password" id="newPassword" placeholder="New Password"
                            class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="changePassword()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition">Update
                            Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js?v=1.5"></script>
    <script>
        checkAuth('patient');
        let profile = null;
        let userId = null;

        async function init() {
            // Get Profile
            const res = await api.get('/auth/me');
            if (res.profile) {
                profile = res.profile;
                userId = res.user.id;
                document.getElementById('navName').innerText = profile.full_name;

                // Populate Modal Profile Info
                const pInfo = document.getElementById('modalProfileInfo');
                if (pInfo) {
                    pInfo.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Name</p>
                                <p class="font-bold text-lg text-white">${profile.full_name}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Contact</p>
                                <p class="font-bold text-lg text-white">${profile.phone}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Age</p>
                                <p class="font-bold text-lg text-white">${profile.age}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 uppercase font-semibold">Gender</p>
                                <p class="font-bold text-lg text-white">${profile.gender}</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Load Departments
            const depts = await api.get('/patient/departments');
            const dSel = document.getElementById('deptSelect');
            const emSel = document.getElementById('emDeptSelect');

            const deptOptions = '<option class="bg-gray-800" value="">Select Department</option>' +
                depts.map(d => `<option class="bg-gray-800" value="${d.id}">${d.name}</option>`).join('');

            dSel.innerHTML = deptOptions;
            if (emSel) emSel.innerHTML = deptOptions;

            loadHistory();
        }

        function getDoctorTitle(deptName) {
            const map = {
                'Cardiology': 'Cardiologist',
                'Neurology': 'Neurologist',
                'Orthopedics': 'Orthopedist',
                'Pediatrics': 'Pediatrician',
                'General Medicine': 'MBBS, General Physician',
                'Dermatology': 'Dermatologist',
                'Gynecology': 'Gynecologist',
                'Gynaecology': 'Gynecologist',
                'Dental': 'Dentist',
                'Psychiatry': 'Psychiatrist',
                'ENT': 'ENT Specialist',
                'Ophthalmology': 'Ophthalmologist'
            };
            return map[deptName] || 'MBBS, General';
        }

        async function loadDoctors() {
            const deptId = document.getElementById('deptSelect').value;
            if (!deptId) return;
            const docs = await api.get(`/patient/doctors?department_id=${deptId}`);
            const docSel = document.getElementById('docSelect');
            docSel.innerHTML = '<option class="bg-gray-800" value="">Select Doctor</option>' +
                docs.map(d => {
                    const title = getDoctorTitle(d.dept_name);
                    return `<option class="bg-gray-800" value="${d.id}">Dr. ${d.full_name} (${title})</option>`;
                }).join('');
        }

        async function checkDate() {
            const docId = document.getElementById('docSelect').value;
            const date = document.getElementById('dateInput').value;
            if (!docId || !date) return;

            try {
                const res = await api.get(`/patient/check-availability?doctor_id=${docId}&date=${date}`);
                if (!res.available) {
                    alert('‚ö†Ô∏è Attention: ' + res.message);
                    document.getElementById('dateInput').value = ''; // Clear invalid date
                }
            } catch (e) { console.error(e); }
        }

        async function bookAppt() {
            const docId = document.getElementById('docSelect').value;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            // Removed isEm check from regular form

            if (!docId || !date || !time) return alert('Please fill all fields');

            try {
                const res = await api.post('/patient/book', {
                    patient_id: profile.id,
                    doctor_id: docId,
                    date: date,
                    time: time + ":00",
                    is_emergency: false // Always false for regular form
                });

                if (res.token) {
                    alert(`Booked Successfully!\n\nYour Token Number: ${res.token}`);
                    loadHistory();
                    document.getElementById('dateInput').value = '';
                    document.getElementById('timeInput').value = '';
                } else {
                    alert(res.message);
                }
            } catch (e) {
                alert(e.message);
            }
        }

        async function bookEmergency() {
            const deptId = document.getElementById('emDeptSelect').value;
            if (!deptId) return alert('Please select a department first!');

            if (!confirm('Please Confirm:\n\nThis is an EMERGENCY booking.\n- It will be booked for NOW.\n- It will be marked as high priority.\n\nProceed?')) return;

            // We need to pick a doctor from that department.
            // Ideally backend handles "next available", but for now let's pick the first one or ask user to pick
            // Let's implement a quick fetch to get any doctor in that dept
            try {
                const docs = await api.get(`/patient/doctors?department_id=${deptId}`);
                if (!docs || docs.length === 0) return alert('No doctors found in this department!');

                // Pick the first one automatically for emergency speed
                const docId = docs[0].id;

                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0];

                const res = await api.post('/patient/book', {
                    patient_id: profile.id,
                    doctor_id: docId,
                    date: dateStr,
                    time: timeStr,
                    is_emergency: true
                });

                if (res.token) {
                    alert(`üö® EMERGENCY BOOKED üö®\n\nPriority Token: ${res.token}\nDoctor: Dr. ${docs[0].full_name}\n\nGo immediately to the department.`);
                    loadHistory();
                } else {
                    alert(res.message);
                }

            } catch (e) {
                alert('Error booking emergency: ' + e.message);
            }
        }

        async function loadHistory() {
            if (!profile) return;
            const res = await api.get(`/patient/appointments/${profile.id}`);
            const tbody = document.getElementById('historyTable');

            if (res.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-8 py-8 text-center text-gray-400">No appointments found.</td></tr>';
                return;
            }

            tbody.innerHTML = res.map(a => `
                <tr class="hover:bg-white/5 transition group">
                    <td class="px-8 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-white">${a.appointment_date}</div>
                        <div class="text-xs text-purple-200">${a.appointment_time}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-white">Dr. ${a.doctor_name}</div>
                        <div class="text-xs text-blue-200">${a.dept_name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-500/20 text-blue-200 font-bold border border-blue-500/30">
                            ${a.token_number}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                         <span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusColor(a.status)} border border-white/10 shadow-sm">
                            ${a.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end gap-3 opacity-80 group-hover:opacity-100 transition">
                            <button onclick="checkQueue(${a.doctor_id}, '${a.appointment_date}')" class="text-yellow-300 hover:text-yellow-200" title="Check Live Queue">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                            ${a.status !== 'cancelled' ? `
                            <a href="http://127.0.0.1:5001/api/patient/prescription/download/${a.id}" target="_blank" class="text-green-300 hover:text-green-200" title="Download PDF">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </a>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(s) {
            if (s === 'pending') return 'bg-yellow-500/20 text-yellow-300';
            if (s === 'completed') return 'bg-green-500/20 text-green-300';
            if (s === 'cancelled') return 'bg-red-500/20 text-red-300';
            return 'bg-gray-500/20 text-gray-300';
        }

        async function checkQueue(docId, date) {
            try {
                // Fix date format if full datetime
                const d = date.split('T')[0];
                const res = await api.get(`/patient/queue-status?doctor_id=${docId}&date=${d}`);
                alert(`Current Serving Token for Dr for date ${d}: ${res.current_token}`);
            } catch (e) {
                alert('Could not fetch queue status');
            }
        }

        // Profile Modal Logic
        function openProfileModal() {
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        async function changePassword() {
            const newPw = document.getElementById('newPassword').value;
            if (!newPw) return alert('Please enter a new password');

            try {
                const res = await api.post('/auth/change-password', {
                    user_id: userId,
                    password: newPw
                });
                if (res.message) {
                    alert('Password updated successfully!');
                    closeProfileModal();
                    document.getElementById('newPassword').value = '';
                } else {
                    alert(res.error || 'Failed to update password');
                }
            } catch (e) {
                alert(e.message);
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        init();
    </script>
</body>

</html>